#{extends 'main.html' /}
#{set title:'Home' /}

#{if schedule}
<section id="schema">
  <div class="page-header">
    <h1>Schema för <span data-bind="text: namn"/></h1>
  </div>
	Det här schemats poäng är ${schedule.score.format('#.##')} (1=idealt schema, 0=sämst tänkbara).<br>
	 <table class="table table-striped table-condensed">
	     <thead>
	         <tr>
		         <th></th>
		         #{list spår, as:'spårnr'}
		             <th>Rum ${spårnr}</th>
			     #{/list}
	         </tr>
	     </thead>
	     <tbody>
	     	<!-- ko foreach: model.schema.sessioner -->
			<tr>
				<td><b>S<span data-bind="text: $index()+1"></span>:</b></td>
		     	<!-- ko foreach: workshops -->
					<td>
						<b>Fråga <span data-bind="text: frageId"></b>
						<ul data-bind="foreach: forskare" class="unstyled">
							<li>
								<div data-bind="template: { name: 'forskar-template', data: model.getForskare($data) }"></div>
							</li>
						</ul>
						<a data-toggle="modal" href="#modalFraga" >Se hela frågan</a>
						<div id="modalFraga" class="modal hide">
							<div data-bind="template: { name: 'modal-fraga-template'}"></div>
						</div>
						
					
					</td>
					
					
					
					
<!--
			         #{list session.workshops, as:'workshop'}
			                 <td><b>Fråga ${workshop.question.q}:</b><br>
			                 #{list workshop.participants, as:'participant'}
			                 		
					                 <!--<i class="icon-arrow-left"></i>
					                 	Tanken här är att pilarna ska bli synliga när man hovrar över forskaren, de ska 
					                 	ligga i en     <div data-bind="visible: pilarSynliga">
					                 	 
					                 	 Och forskaren ligger i en sån här div:
					                 	 <div data-bind="event: { mouseover: visaPilar, mouseout: tabortPilar }">
					                 ->
			                         <div>
			                         	${participant.first_name}, Inst för neurologi, Uppsala Universitet
			                         </div>
					                 <!--<i class="icon-arrow-right"></i> ->
			                 #{/list}		                 
			                 </td>
			         #{/list}
-->	             

					
					
					
					
					
				<!-- /ko -->
			</tr>
			<!-- /ko -->
			
		</tbody>
	 </table>
	 
	#{if schedule.unplacedQuestions}
		<br>I det här schemat misslyckades vi att placera ut:
		#{list schedule.unplacedQuestions, as:'unplaced'}
		        Fråga ${unplaced.q}
		#{/list}
	#{/if}
	<p>
	#{if schedule.unsatisfied}
		I det här schemat fick följande (${schedule.unsatisfied.size} st) deltagare inte vara med på hela sin önskelista:
		#{list schedule.unsatisfied, as:'un'}
		         <div "unsatisfied_participant">${un.participant.first_name} önskade ${un.wishedNumber} st, fick se ${un.assignedNumber} st </div>
		#{/list}                        
	#{/if}
	<p>
	Om du är nöjd med det här schemat så kan du spara det:<br>
	<a data-toggle="modal" href="#myModal" class="btn btn-primary">Spara schema</a>
	<p>Om inte kan du generera ett nytt schema: 
	
	  <div id="myModal" class="modal hide">
	    <div class="modal-header">
	      <button type="button" class="close" data-dismiss="modal">&times;</button>
	    </div>
	    <div class="modal-body">
	      <h4>Det här funkar inte riktigt</h4>
	      <p>Det som kommer att hända här är att schemat skickas tillbaka till registreringsmodulen för att sparas i 
	      dess databas. Den delen är inte gjord än... 
	    </div>
	    <div class="modal-footer">
	      <a href="#" class="btn btn-primary" data-dismiss="modal">OK</a>
	    </div>
	  </div>


	
	
	
</section>
#{/if}
<section id="fragor">
  <div class="page-header">
    <h1>Frågor</h1>
  </div>

	<table>
	    <thead>
	    </thead>
	    <tbody data-bind="foreach: model.fragor">
	        <tr>
	            <td data-bind="text: id"></td>
	            <td data-bind="text: fråga"></td>
	            <td data-bind="visible: !editing()">
	            	<a href="#" data-bind="click: edit">Låst till session <span data-bind="text: låst"></a>
	            	<a href="#" data-bind="visible: ärLåst, click: removeLås"> (ta bort alla sessionslås)</a> 
	            </td>
	            <td><select data-bind="visible: editing, hasfocus: editing, options: model.sessioner, selectedOptions: låst" multiple="true"></select></td>
	        </tr>
	    </tbody>
	</table>

</section>
<section id="forskare">
  <div class="page-header">
    <h1>Forskare</h1>
  </div>
	
	<table>
	    <thead>
	    </thead>
	    <tbody data-bind="foreach: model.forskare">
	        <tr>
	            <td>
					<div data-bind="template: { name: 'forskar-template' }"></div>
	            </td>
	            <td data-bind="visible: !editingSession()">
	            	<a href="#" data-bind="click: edit">Låst till session <span data-bind="text: låstaSessioner"></a>
	            	<a href="#" data-bind="visible: ärLåst, click: removeLås"> (ta bort alla sessionslås)</a> 
	            </td>
	            <td><select data-bind="visible: editingSession, hasfocus: editingSession, options: model.sessioner, selectedOptions: låstaSessioner" multiple="true"></select></td>

	            <td data-bind="visible: !editingFraga()">
	            	<a href="#" data-bind="click: editFraga">Låst till fråga <span data-bind="text: låstaFrågor"></a>
	            	<a href="#" data-bind="visible: ärLåstTillFråga, click: removeFrågeLås"> (ta bort alla frågelås)</a> 
	            </td>
	            <td><select data-bind="visible: editingFraga, hasfocus: editingFraga, options: frageIdn, selectedOptions: låstaFrågor" multiple="true"></select></td>
	            
	        </tr>
	    </tbody>
	</table>
</section>
	
<section id="generera">
  <div class="page-header">
    <h1></h1>
  </div>

	<form action="@{Application.schedule()}" method="POST" accept-charset="${_response_encoding}" data-bind="submit: model.generera">
	     <label for="tracks">Antal parallella spår</label>
	     <input type="text" name="tracks" value="10" id="tracks" />
	     <label for="sessions">Antal sessioner</label>
	     <input type="text" name="sessions" value="5" id="sessions" />
	     <label for="generations">Antal generationer</label>
	     <input type="text" name="generations" value="2000" id="generations" />
	     <label for="placeWeight">Att frågor är utplacerade</label>
	     <input type="text" name="placeWeight" value="10" id="placeWeight" />
	     <label for="wsWeight">Att varje fråga har fyllts med erfarna deltagare (och att den har kliniker om det behövs)</label>
	     <input type="text" name="wsWeight" value="10" id="wsWeight" />
	     <label for="agendaWeight">Att forskarnas önskemål är tillgodosedda</label>
	     <input type="text" name="agendaWeight" value="10" id="agendaWeight" />
	     <input type="hidden" data-bind="value: model.genereradJson" name="json"></input>
	     <br>
		<button type="submit" class="btn btn-primary" >Generera nytt schema</button>
	 </form>
</section>

<section id="todo">
  <div class="page-header">
    <h1>TODOs</h1>
  </div>
	<p>
	* post-url i json
	* Kolla med UU innov om de vill öppna i en ny tab i stället (lägg till  target="_blank" till formuläret isf)
	<p>
</section>



<script type="text/html" id="forskar-template">
	<span data-bind="if: harVikt">
	<a href="#" title="Den här forskaren är markerad att ha specifik kompetens för den här konferensen (har vikt som används i optimeringen)"><i class="icon-flag"></i></a></span>
	<span data-bind="if: joker">
	<a href="#" title="Den här forskaren är joker och placeras ut sist av alla på de frågor som behöver mer kompetens"><i class="icon-star"></i></a></span>
	<span data-bind="text: model.getGrad(grad)"></span>&nbsp<span data-bind="text: namn"></span>, <span data-bind="text: kontakt().avdelning"></span> 
</script>

<script type="text/html" id="rep-template">
	<span data-bind="text: namn"></span>, <span data-bind="text: kontakt().avdelning"></span> <span data-bind="text: kontakt().org"></span> 
</script>

<script type="text/html" id="modal-fraga-template">
    <div class="modal-header">
      Fråga <span data-bind="text: frageId"></span><button type="button" class="close" data-dismiss="modal">&times;</button>
    </div>
    <div class="modal-body">
		<ul data-bind="foreach: forskare" class="unstyled">
			<li>
				<div data-bind="template: { name: 'forskar-template', data: model.getForskare($data) }"></div>
			</li>
		</ul>
		<ul data-bind="foreach: foretagsrepresentanter" class="unstyled">
			<li>
				<div data-bind="template: { name: 'rep-template', data: model.getRep($data) }"></div>
			</li>
		</ul>
    </div>
    <div class="modal-footer">
    	<a href="#" class="btn btn-primary" data-dismiss="modal">OK</a>
    </div>
</script>


<script type="text/javascript">

	var json = ${json.raw()};
	var model = new KonferensModel();
	model.id = json.id;
	model.namn = json.namn;
	model.optimeringsInformation = json.optimeringsInformation;
	model.senioritetsgrader = json.senioritetsgrader;
	model.schema = new Schema(json.schema);

	for (var i = 0; i < json.foretagsrepresentanter.length; i++) {
	    var f = json.foretagsrepresentanter[i];
		model.foretagsrepresentanter.push(new Foretagsrepresentant(f));
	}
	for (var i = 0; i < json.fragor.length; i++) {
	    var f = json.fragor[i];
		model.fragor.push(new Fråga(f));
	}
	for (var i = 0; i < json.forskare.length; i++) {
	    var f = json.forskare[i];
		model.forskare.push(new Forskare(f));
	}
	ko.applyBindings(model);

    function Schema(s){
    	var self = this;
		self.sessioner = ko.observableArray();
		for (var i = 0; i < s.sessioner.length; i++) {
		    var session = s.sessioner[i];
			self.sessioner.push(new Session(session));
		}
    }
    
    function Session(s){
    	var self = this;
		self.workshops = ko.observableArray();
		for (var i = 0; i < s.workshops.length; i++) {
		    var workshop = s.workshops[i];
			self.workshops.push(new Workshop(workshop));
		}
    }
    
    function Workshop(s){
    	var self = this;
    	self.frageId = s.frageId;
		self.forskare = ko.observableArray();
		self.foretagsrepresentanter = s.foretagsrepresentanter;
		for (var i = 0; i < s.forskare.length; i++) {
		    var f = s.forskare[i];
			self.forskare.push(f);
		}
    }
    
    function Fråga(f){
    	var self = this;
    	self.id = ko.observable(f.id);
    	self.fråga = ko.observable(f.fråga);
    	self.låst = ko.observableArray(f.låst);

	    self.editing = ko.observable(false);
	    self.edit = function() { this.editing(true); }
	    
	    self.ärLåst = ko.computed(function(){return self.låst() != null && self.låst().length > 0;}, this);
		self.removeLås = function(formElement) {
			self.låst.removeAll();
        }
    }
    
    function Foretagsrepresentant(f){
    	var self = this;
    	self.id = ko.observable(f.id);
    	self.kontakt = ko.observable(f.kontakt);
    	self.namn = ko.computed(function(){return self.kontakt().fornamn + " " + self.kontakt().efternamn;}, this);
    	self.frågor = f.frågor;
    }

    function Forskare(f){
    	var self = this;
    	self.id = ko.observable(f.id);
    	self.harVikt = ko.observable(f.harVikt);
    	self.kontakt = ko.observable(f.kontakt);
    	self.namn = ko.computed(function(){return self.kontakt().fornamn + " " + self.kontakt().efternamn;}, this);
    	self.grad = f.grad;
    	self.joker = f.joker;
    	self.frågor = f.frågor;
    	self.låstaSessioner = ko.observableArray(f.låstaSessioner);
        self.frageIdn = ko.observableArray();
		for (var i = 0; i < f.frågor.length; i++) {
	    	self.frageIdn.push(f.frågor[i]);
		}
    	self.låstaFrågor = ko.observableArray(f.låstaFrågor);
        
        
	    self.editingSession = ko.observable(false);
	    self.edit = function() { this.editingSession(true); }
	    self.ärLåst = ko.computed(function(){return self.låstaSessioner() != null && self.låstaSessioner().length > 0;}, this);
		self.removeLås = function(formElement) {
			self.låstaSessioner.removeAll();
        }

	    self.editingFraga = ko.observable(false);
	    self.editFraga = function() { this.editingFraga(true); }
    	self.ärLåstTillFråga = ko.computed(function(){return self.låstaFrågor() != null && self.låstaFrågor().length > 0;}, this);
		self.removeFrågeLås = function(formElement) {
			self.låstaFrågor.removeAll();
        }
	    
    }
    
    function KonferensModel(){
    	var self = this;
		self.sessioner = [1,2,3,4,5,6]; // Antar att vi bara tillåter så här många sessioner
    	self.fragor = ko.observableArray();
    	self.forskare = ko.observableArray();
    	self.foretagsrepresentanter = ko.observableArray();
		self.genereradJson = ko.observable();

		// när generera-knappen trycks så måste vi plocka ut de ändringar som gjorts (låsningar) och
		// skicka med dem till servern
		self.generera = function(formElement) {
			var newJson = ko.toJSON(self);
			self.genereradJson(newJson);
			console.log(newJson);
			return true;
        }
        
        self.getForskare = function(id){
        	var len = self.forskare().length;
        	for(var i = 0 ; i < len; i ++){
	        	var f = self.forskare()[i];
	        	
	        	if (f.id() === id){
	        		return f;
	        	}
        	}
        	console.log("failed to find forskare with id " + id);
        }
        
        self.getRep = function(id){
        	
        	var len = self.foretagsrepresentanter().length;
        	for(var i = 0 ; i < len; i ++){
	        	var f = self.foretagsrepresentanter()[i];
	        	
	        	if (f.id() === id){
	        		return f;
	        	}
        	}
        	console.log("failed to find foretagsrepresentant with id " + id);
        }
        
        self.getGrad = function(grad){
        	return self.senioritetsgrader[grad];
        }
    }
	
</script>
	