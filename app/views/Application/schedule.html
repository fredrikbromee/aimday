#{extends 'main.html' /}
#{set title:'Home' /}

#{if schedule}
<section id="schema">
  <div class="page-header">
    <h1>Schema</h1>
  </div>
	Det här schemats poäng är ${schedule.score.format('#.##')} (1=idealt schema, 0=sämst tänkbara).<br>
	 <table class="table table-striped table-condensed">
	     <thead>
	         <tr>
		         <th></th>
		         #{list spår, as:'spårnr'}
		             <th>Rum ${spårnr}</th>
			     #{/list}
	         </tr>
	     </thead>
	     <tbody>
	         #{list schedule.sessions, as:'session'}
	             <tr>
	                 <td><b>S${session.sessionNumber}:</b></td> 
			         #{list session.workshops, as:'workshop'}
			                 <td><b>Fråga ${workshop.question.q}:</b><br> 
			                 #{list workshop.participants, as:'participant'}
					                 <i class="icon-fire"></i>
			                         ${participant.first_name}<br>
			                 #{/list}		                 
			                 </td>
			         #{/list}
	             </tr>
	         #{/list}
	     </tbody>
	 </table>
	 
	#{if schedule.unplacedQuestions}
		<br>I det här schemat misslyckades vi att placera ut:
		#{list schedule.unplacedQuestions, as:'unplaced'}
		        Fråga ${unplaced.q}
		#{/list}
	#{/if}
	<p>
	#{if schedule.unsatisfied}
		I det här schemat fick följande (${schedule.unsatisfied.size} st) deltagare inte vara med på hela sin önskelista:
		#{list schedule.unsatisfied, as:'un'}
		         <div "unsatisfied_participant">${un.participant.first_name} önskade ${un.wishedNumber} st, fick se ${un.assignedNumber} st </div>
		#{/list}                        
	#{/if}
</section>
#{/if}
<section id="fragor">
  <div class="page-header">
    <h1>Frågor <small>(lägg låsning i en pop-over?)</small></h1>
  </div>

	<table>
	    <thead>
	    </thead>
	    <tbody data-bind="foreach: model.fragor">
	        <tr>
	            <td data-bind="text: id"></td>
	            <td data-bind="text: fråga"></td>
	            <td data-bind="visible: ärLåst">Låst till session <span data-bind="text: låst"> </span></td>
	            <td><select data-bind="options: model.sessioner, selectedOptions: låst" multiple="true"></select></td>
	            <td data-bind="visible: ärLåst">
	            	<form data-bind="submit: removeLås">
		    			<button type="submit">Ta bort alla lås för den här frågan</button>
					</form>
	            </td>
	        </tr>
	    </tbody>
	</table>

</section>
<section id="forskare">
  <div class="page-header">
    <h1>Forskare</h1>
  </div>
	
	<table>
	    <thead>
	    </thead>
	    <tbody data-bind="foreach: model.forskare">
	        <tr>
	            <td data-bind="text: id"></td>
	            <td data-bind="text: namn"></td>
	            <td data-bind="visible: ärLåst">Låst till session <span data-bind="text: låstaSessioner"> </span></td>
	            <td><select data-bind="options: model.sessioner, selectedOptions: låstaSessioner" multiple="true"></select></td>
	            <td data-bind="visible: ärLåst">
	            	<form data-bind="submit: removeLås">
		    			<button type="submit">Ta bort alla lås för den här frågan</button>
					</form>
	            </td>
	        </tr>
	    </tbody>
	</table>
</section>
	
<section id="generera">
  <div class="page-header">
    <h1>Generera nytt schema</h1>
  </div>

	<form action="@{Application.schedule()}" method="POST" accept-charset="${_response_encoding}" data-bind="submit: model.generera">
	     <label for="tracks">Antal parallella spår</label>
	     <input type="text" name="tracks" value="10" id="tracks" />
	     <label for="sessions">Antal sessioner</label>
	     <input type="text" name="sessions" value="5" id="sessions" />
	     <label for="generations">Antal generationer</label>
	     <input type="text" name="generations" value="2000" id="generations" />
	     <label for="placeWeight">Att frågor är utplacerade</label>
	     <input type="text" name="placeWeight" value="10" id="placeWeight" />
	     <label for="wsWeight">Att varje fråga har fyllts med erfarna deltagare (och att den har kliniker om det behövs)</label>
	     <input type="text" name="wsWeight" value="10" id="wsWeight" />
	     <label for="agendaWeight">Att forskarnas önskemål är tillgodosedda</label>
	     <input type="text" name="agendaWeight" value="10" id="agendaWeight" />
	     <input type="hidden" data-bind="value: model.genereradJson" name="json"></input>
	     &nbsp;
		<button type="submit">Generera nytt schema</button>
	 </form>
</section>

<section id="todo">
  <div class="page-header">
    <h1>TODOs</h1>
  </div>
	<p>
	* popovers
	* loopa över spår när man lägger ut frågor
	* Kolla med UU innov om de vill öppna i en ny tab i stället (lägg till  target="_blank" till formuläret isf)
	<p>
</section>

<script type="text/javascript">

	var json = ${json.raw()};
	var model = new KonferensModel();
	model.id = json.id;
	model.namn = json.namn;
	model.optimeringsInformation = json.optimeringsInformation;
	model.senioritetsgrader = json.senioritetsgrader;
	model.företagsrepresentanter = json.företagsrepresentanter;
	model.schema = json.schema;

	for (var i = 0; i < json.fragor.length; i++) {
	    var f = json.fragor[i];
		model.fragor.push(new Fråga(f));
	}
	for (var i = 0; i < json.forskare.length; i++) {
	    var f = json.forskare[i];
		model.forskare.push(new Forskare(f));
	}
	ko.applyBindings(model);

    function Fråga(f){
    	var self = this;
    	self.id = ko.observable(f.id);
    	self.fråga = ko.observable(f.fråga);
    	self.låst = ko.observableArray(f.låst);
    	self.ärLåst = ko.computed(function(){return self.låst() != null && self.låst().length > 0;}, this);
		self.removeLås = function(formElement) {
			self.låst.removeAll();
        }
    }
    
    function Forskare(f){
    	var self = this;
    	self.id = ko.observable(f.id);
    	self.harVikt = ko.observable(f.harVikt);
    	self.kontakt = ko.observable(f.kontakt);
    	self.namn = ko.computed(function(){return self.kontakt().fornamn + " " + self.kontakt().efternamn;}, this);
    	self.grad = f.grad;
    	self.joker = f.joker;
    	self.frågor = f.frågor;
    	self.låstaSessioner = ko.observableArray(f.låstaSessioner);
    	self.ärLåst = ko.computed(function(){return self.låstaSessioner() != null && self.låstaSessioner().length > 0;}, this);
		self.removeLås = function(formElement) {
			self.låstaSessioner.removeAll();
        }
    }
    
    function KonferensModel(){
    	var self = this;
		self.sessioner = [1,2,3,4,5,6]; // Antar att vi bara tillåter så här många sessioner
    	self.fragor = ko.observableArray();
    	self.forskare = ko.observableArray();
		self.genereradJson = ko.observable();
		self.generera = function(formElement) {
			var newJson = ko.toJSON(self);
			self.genereradJson(newJson);
			console.log(newJson);
			return true;
        }
    }
	
</script>


